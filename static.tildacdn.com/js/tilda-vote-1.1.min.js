function tvote__init(t){if(void 0===$(".t-records").attr("data-tilda-mode")){var e=new Date;mouseMoved=!1,$(document).on("touchstart mousemove",function(t){mouseMoved=!0});var o=$("#rec"+t).find(".t-vote"),n=tvote__makeFullVoteID(o),i={type:o.attr("data-vote-type"),voteID:n,voteEl:o,voteVisibility:o.attr("data-vote-visibility"),startDate:e};tvote__checkVoteCondition(i),"yes"!=o.attr("data-vote-finished")?setTimeout(function(){tvote__initOneVote(i)},500):o.addClass("t-vote_sended")}}function tvote__makeFullVoteID(t){var e=t.attr("data-vote-id");if(void 0!==e){var o=$(".t-records").attr("data-tilda-project-id")+e;return o=o.replace("&quot;","").replace("&#039;","").replace(/[&\/\\#,+()$~%.'":;*?!<>{}\-_\s]/g,""),t.attr("data-vote-id",o),o}}function tvote__initOneVote(t){t.voteEl.find(".js-sendvote-btn").on("click",function(e){if(!t.voteEl.hasClass("js-vote-sending")){var o=!0;"single"==t.type&&(t.answerID=$(this).parents(".js-vote-item").attr("data-answer-id"),t.clickedEl=$(this),t.url="https://vote.tildacdn.com/vote/1/",o=tvote__handleClick__single(t)),"multi"==t.type&&(t.url="https://vote.tildacdn.com/vote/2/",o=tvote__handleClick_multi(t)),o&&(tvote__itemSend(t),e.preventDefault())}})}function tvote__handleClick__single(t){return!(!t.clickedEl.hasClass("t-vote__btn-el_active")&&t.voteEl.hasClass("js-vote-sended"))&&(!t.clickedEl.hasClass("t-vote__btn-el_active")||!t.voteEl.hasClass("js-vote-sended")||(void 0!==tvote__getCookie("vote_candelete"+t.voteID)&&tvote__itemDelete_single(t),!1))}function tvote__handleClick_multi(t){var e=[],o=t.voteEl.find(".js-vote-question:has(.js-vote-btn:checked)"),n=t.voteEl.find(".js-vote-question").length;return!t.voteEl.hasClass("js-vote-sended")&&(o.length!=n?("RU"==window.tildaBrowserLang?tvote__showError(t.voteID,"Пожалуйста, ответьте на все вопросы."):tvote__showError(t.voteID,"Please, answer all questions."),!1):(o.each(function(){var o=$(this).attr("data-question-id"),n=$(this).find(".js-vote-btn:checked"),i=[];n.each(function(){var e=$(this).parents(".js-vote-item").attr("data-answer-id");i.push(e+"-"+o+"-"+t.voteID)}),e.push({answer:i,question:o})}),t.answerArr=e,!0))}function tvote__itemSend(t){t.seconds_fromStart=((new Date).getTime()-t.startDate.getTime())/1e3,tvote__changeVoteCondition(t,"add"),t.voteEl.addClass("js-vote-sending t-multivote_sended"),tvote__addLoadingStyle(t.voteEl,t.voteID),"onclick"==t.voteVisibility&&t.voteEl.find(".t-vote__btn-res").css("display","block"),$.ajax({type:"POST",url:t.url+"init/",crossDomain:!0,xhrFields:{withCredentials:!0},data:{host:location.protocol+"//"+location.host},dataType:"text",async:!1,success:function(e){var o=$.parseJSON(e);"object"!=typeof o&&tvote__showError(t.voteID,""),t.sessionKey=o.key,t.sessionCookie=o.session,t.voteHash=t.voteID+t.sessionKey,tvote__itemSend_continue(t)},error:function(e){console.log("Fatal error:"),console.log(e),tvote__changeVoteCondition(t,"remove"),tvote__showError(t.voteID,"")},timeout:15e3})}function tvote__itemSend_continue(t,e){var o=$(".t-records").attr("data-tilda-page-id"),n=$(".t-records").attr("data-tilda-project-id"),i={hash:t.voteHash,projectid:n,pageid:o,host:location.protocol+"//"+location.host,time:t.seconds_fromStart,session:t.sessionCookie};"single"==t.type&&(i.voteid=t.voteID,i.answerid=t.answerID),"multi"==t.type&&(i.multivoteid=t.voteID,i.answers=t.answerArr),void 0!==e&&(i.votecaptcha=e,tvote__changeVoteCondition(t,"add")),$.ajax({type:"POST",url:t.url+"send/",crossDomain:!0,xhrFields:{withCredentials:!0},data:i,dataType:"text",success:function(e){t.voteEl.removeClass("js-vote-sending t-vote_loading");var o=$.parseJSON(e);"object"!=typeof o&&tvote__showError(t.voteID,""),void 0===o.error?(t.voteEl.addClass("js-vote-sended t-vote_sended"),tvote__writeSendCookie(o,t),t.voteEl.find(".t-vote__errorbox").remove(),$(".t-vote").trigger("tildavote:resultsended")):(tvote__changeVoteCondition(t,"remove"),t.voteEl.removeClass("t-vote_sended"),tvote__handleServerError(o,t))},error:function(e){console.log("Fatal error:"),console.log(e),tvote__showError(t.voteID,"")},timeout:15e3})}function tvote__writeSendCookie(t,e){"ok"==t.message&&(tvote__setCookie("vote"+t.voteid,e.voteHash,{expires:86400}),"single"==e.type&&(tvote__setCookie("voteresult"+t.voteid,e.answerID,{expires:86400}),tvote__setCookie("vote_candelete"+t.voteid,"yes",{expires:1800})))}function tvote__itemDelete_single(t){(new Date).getTime(),t.startDate.getTime();tvote__changeVoteCondition(t,"remove"),t.voteEl.addClass("js-vote-sending").removeClass("t-vote_sended"),tvote__addLoadingStyle(t.voteEl,t.voteID),t.voteHash=tvote__getCookie("vote"+t.voteID),$.ajax({type:"POST",url:"https://vote.tildacdn.com/vote/1/delete/",crossDomain:!0,data:{voteid:t.voteID,hash:t.voteHash,host:location.protocol+"//"+location.host},dataType:"text",success:function(e){t.voteEl.removeClass("js-vote-sending t-vote_loading");var o=$.parseJSON(e);"object"!=typeof o&&tvote__showError(voteID,""),void 0===o.error?(t.voteEl.removeClass("js-vote-sended t-vote_sended"),tvote__removeSendCookie(o,t)):(tvote__changeVoteCondition(t,"add"),t.voteEl.addClass("t-vote_sended"),tvote__handleServerError(o,t))},error:function(e){console.log("Fatal error:"),console.log(e),tvote__showError(t.voteID,"")},timeout:15e3})}function tvote__removeSendCookie(t,e){"ok"==t.message&&(tvote__setCookie("vote"+t.voteid,e.voteHash,{expires:1}),tvote__setCookie("voteresult"+t.voteid,"",{expires:1}),tvote__setCookie("vote_candelete"+t.voteid,"",{expires:1}))}function tvote__addLoadingStyle(t,e){setTimeout(function(){t.hasClass("js-vote-sending")&&t.addClass("t-vote_loading")},150)}function tvote__checkVoteCondition(t){var e=tvote__getCookie("vote"+t.voteID),o=tvote__getCookie("voteresult"+t.voteID);("yes"==t.voteVisibility||"onclick"==t.voteVisibility&&void 0!==e)&&t.voteEl.find(".t-vote__btn-res").css("display","block"),void 0!==e&&t.voteEl.addClass("js-vote-sended t-vote_sended"),"single"==t.type&&void 0!==e&&void 0!==o&&t.voteEl.find("[data-answer-id="+o+"] .t-vote__btn-el").addClass("t-vote__btn-el_active"),tvote__getResult(t.voteID)}function tvote__handleServerError(t,e){if(6==t.error)return window.tvote_opts=e,void addTildaCaptcha();var o="";o="RU"==window.tildaBrowserLang?"Что-то пошло не так и голосование не может корректно работать. Пожалуйста, попробуйте другой браузер, отключите режим инкогнито или обратитесь к владельцу сайта.":"Something went wrong and vote doesn't work correctly. Please, try another browser, unlock private mode or write to website owner.",1==t.error&&(o="RU"==window.tildaBrowserLang?"С этого IP недавно голосовали. Пожалуйста, подождите 10 минут и попробуйте еще раз.":"Somebody has recently voted from this IP. Please, wait 10 minutes and try again."),2==t.error&&(o="RU"==window.tildaBrowserLang?"С вашего IP адреса приходит слишком много запросов к серверу. Сервер временно не может принимать голоса с этого IP. Пожалуйста, попробуйте еще раз позже.":"There are too many votes from your IP. Server temporarily can't get votes from this IP. Please, try again later."),4==t.error&&(o="RU"==window.tildaBrowserLang?"Извините, но голос удалить уже нельзя. Удалить голос можно только в течение 30 минут после активации.":"Sorry, but you can't delete vote now. You can delete votes just during 30 minutes after activation."),5==t.error&&(o="RU"==window.tildaBrowserLang?"С вашего IP запросы приходят слишком часто. Пожалуйста, подождите 7 секунд прежде чем выбирать ответы в слудующих голосованиях на странице.":"Votes are sended too often from your IP. Please, wait 7 seconds between choosing answers in different votes."),tvote__showError(e.voteID,o)}function addTildaCaptcha(){$("#tildavotecaptchabox").remove(),$("body").append('<div id="tildavotecaptchabox" style="z-index: 100000;position:fixed; text-align: center; vertical-align: middle; top: 0px; left:0px; bottom: 0px; right: 0px; background: rgba(255,255,255,0.97);"><iframe id="captchaIframeBox" src="https://vote.tildacdn.com/vote/1/send/showcaptcha.php" frameborder="0" width="100%" height="100%"></iframe></div>'),window.removeEventListener("message",checkVerifyTildaVoteCaptcha),window.addEventListener("message",checkVerifyTildaVoteCaptcha)}function checkVerifyTildaVoteCaptcha(){if(-1!=event.origin.indexOf("vote.tildacdn.com")){if("closeiframe"==event.data)return void $("#tildaformcaptchabox").remove();$("#tildavotecaptchabox").remove(),tvote__itemSend_continue(window.tvote_opts,event.data)}}function tvote__showError(t,e){""==e&&(e="RU"==window.tildaBrowserLang?"Что-то пошло не так и голосование может работать некорректно. Пожалуйста, проверьте соединение с интернетом или обратитесь к владельцу сайта.":"Something went wrong and vote doesn't work correctly. Please, check your internet connection or write to website owner.");var o=$("[data-vote-id="+t+"]"),n=o.attr("data-vote-type");if("single"==n||void 0===n){var i="<div class='t-vote__errorbox'><div class='t-vote__errorbox-text t-text t-text_xs t-align_center' style='background-color:#333;color:#fff;padding:20px;margin-top:30px;'>"+e+"</div></div>";o.after(i),o.css("display","none")}if("multi"==n){o.find(".t-vote__errorbox").remove();i="<div class='t-vote__errorbox'><div class='t-vote__errorbox-text t-text t-text_xs t-align_center' style='background-color:#F95D51;color:#fff;padding:20px;margin:30px 0px;'>"+e+"</div></div>";o.find(".js-sendvote-btn").last().before(i)}}function tvote__getResult(t){var e=$("[data-vote-id="+t+"]"),o=e.attr("data-vote-type");if("single"==o)var n="https://vote.tildacdn.com/vote/1/getresult/";if("multi"==o)n="https://vote.tildacdn.com/vote/2/getresult/";void 0!==o&&$.ajax({type:"GET",url:n,crossDomain:!0,data:{voteid:t,host:location.protocol+"//"+location.host},async:!1,dataType:"text",success:function(n){var i=$.parseJSON(n);"object"!=typeof i&&tvote__showError(t,""),void 0===i.error?("single"==o&&Object.keys(i[0]).forEach(function(t,o){e.find("[data-answer-id="+t+"] .js-vote-count").html(i[0][t])}),"multi"==o&&($.each(i[0],function(t,o){var n=0;$.each(o,function(t,e){n+=1*e}),$.each(o,function(o,i){var a=Math.round(100*i/n),r=e.find("[data-question-id="+t+"] [data-answer-id="+o.slice(0,1)+"]");r.find(".js-vote-count").html(i),r.find(".js-vote-percent").html(a+"%")})}),setTimeout(function(){$(".t-vote").trigger("tildavote:numberschanged")},1e3))):e.find(".t-vote__btn-res").css("display","none")},error:function(e){console.log("Fatal error:"),console.log(e),tvote__showError(t,"")},timeout:5e3})}function tvote__changeVoteCondition(t,e){"multi"==t.type&&tvote__changeStat(t,e),"single"==t.type&&"add"==e&&(tvote__incrementAnswerNum(t.voteID,t.answerID),t.voteEl.find("[data-answer-id="+t.answerID+"] .t-vote__btn-el").addClass("t-vote__btn-el_active")),"single"==t.type&&"remove"==e&&(tvote__decrementAnswerNum(t.voteID,t.answerID),t.voteEl.find(".t-vote__btn-el_active").removeClass("t-vote__btn-el_active"))}function tvote__changeStat(t,e){t.voteEl.find(".js-vote-question").each(function(){var t=$(this).find(".js-vote-item"),o=0;t.each(function(){var t=$(this).find(".js-vote-count");if(void 0!==t){var n=1*t.html();o+=n;var i=$(this).find(".js-vote-btn:checked").length;0!=i&&"add"==e&&(o++,n++,t.html(n)),0!=i&&"remove"==e&&(o--,n--,t.html(n))}}),t.each(function(){var t=$(this).find(".js-vote-count"),e=$(this).find(".js-vote-percent"),n=1*t.html(),i=Math.round(100*n/o);0!=o?(t.html(n),void 0!==e&&e.html(i+"%")):(t.html("0"),void 0!==e&&e.html("0%"))})}),$(".t-vote").trigger("tildavote:numberschanged")}function tvote__incrementAnswerNum(t,e){var o=$("[data-vote-id="+t+"] [data-answer-id="+e+"] .js-vote-count"),n=o.html();o.html(1*++n)}function tvote__decrementAnswerNum(t,e){var o=$("[data-vote-id="+t+"] [data-answer-id="+e+"] .js-vote-count"),n=o.html();o.html(1*--n)}function tvote__getCookie(t){var e=document.cookie.match(new RegExp("(?:^|; )"+t.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)"));return e?decodeURIComponent(e[1]):void 0}function tvote__setCookie(t,e,o){var n=(o=o||{}).expires;if("number"==typeof n&&n){var i=new Date;i.setTime(i.getTime()+1e3*n),n=o.expires=i}n&&n.toUTCString&&(o.expires=n.toUTCString());var a=t+"="+(e=encodeURIComponent(e));for(var r in o){a+="; "+r;var s=o[r];!0!==s&&(a+="="+s)}document.cookie=a}
