function tvote__init(recid){if(void 0===$(".t-records").attr("data-tilda-mode")){var startDate=new Date,el_vote=$("#rec"+recid).find(".t-vote"),fullID=tvote__makeFullVoteID(el_vote),opts={type:el_vote.attr("data-vote-type"),voteID:fullID,voteEl:el_vote,voteVisibility:el_vote.attr("data-vote-visibility"),startDate:startDate};tvote__checkVoteCondition(opts),"yes"!=el_vote.attr("data-vote-finished")?setTimeout((function(){tvote__initOneVote(opts)}),500):el_vote.addClass("t-vote_sended")}}function tvote__makeFullVoteID(voteEl){var voteID=voteEl.attr("data-vote-id");if(void 0!==voteID){var fullVoteID=$(".t-records").attr("data-tilda-project-id")+voteID;return fullVoteID=fullVoteID.replace("&quot;","").replace("&#039;","").replace(/[&/\\#,+()$~%.'":;*?!<>{}\-_\s]/g,""),voteEl.attr("data-vote-id",fullVoteID),fullVoteID}}function tvote__initOneVote(opts){opts.voteEl.find(".js-sendvote-btn").on("click",(function(e){if(!opts.voteEl.hasClass("js-vote-sending")){var sendVote=!0;"single"==opts.type&&(opts.answerID=$(this).parents(".js-vote-item").attr("data-answer-id"),opts.clickedEl=$(this),opts.url="https://vote.tildacdn.com/vote/1/",sendVote=tvote__handleClick__single(opts)),"multi"==opts.type&&(opts.url="https://vote.tildacdn.com/vote/2/",sendVote=tvote__handleClick_multi(opts)),sendVote&&(tvote__itemSend(opts),e.preventDefault())}}))}function tvote__handleClick__single(opts){return!(!opts.clickedEl.hasClass("t-vote__btn-el_active")&&opts.voteEl.hasClass("js-vote-sended"))&&(!opts.clickedEl.hasClass("t-vote__btn-el_active")||!opts.voteEl.hasClass("js-vote-sended")||(void 0!==tvote__getCookie("vote_candelete"+opts.voteID)&&tvote__itemDelete_single(opts),!1));var canDeleteCookie}function tvote__handleClick_multi(opts){var result=[],answeredVotes=opts.voteEl.find(".js-vote-question:has(.js-vote-btn:checked)"),votesNum=opts.voteEl.find(".js-vote-question").length;return!opts.voteEl.hasClass("js-vote-sended")&&(answeredVotes.length!=votesNum?("RU"==window.tildaBrowserLang?tvote__showError(opts.voteID,"Пожалуйста, ответьте на все вопросы."):tvote__showError(opts.voteID,"Please, answer all questions."),!1):(answeredVotes.each((function(){var questionID=$(this).attr("data-question-id"),questionAnswers=$(this).find(".js-vote-btn:checked"),questionResult=[];questionAnswers.each((function(){var answerId=$(this).parents(".js-vote-item").attr("data-answer-id");questionResult.push(answerId+"-"+questionID+"-"+opts.voteID)})),result.push({answer:questionResult,question:questionID})})),opts.answerArr=result,!0))}function tvote__itemSend(opts){opts.seconds_fromStart=((new Date).getTime()-opts.startDate.getTime())/1e3,tvote__changeVoteCondition(opts,"add"),opts.voteEl.addClass("js-vote-sending t-multivote_sended"),tvote__addLoadingStyle(opts.voteEl),"onclick"==opts.voteVisibility&&opts.voteEl.find(".t-vote__btn-res").css("display","block"),$.ajax({type:"POST",url:opts.url+"init/",crossDomain:!0,xhrFields:{withCredentials:!0},data:{host:location.protocol+"//"+location.host},dataType:"text",async:!1,success:function(data){var obj=$.parseJSON(data);"object"!=typeof obj&&tvote__showError(opts.voteID,""),opts.sessionKey=obj.key,opts.sessionCookie=obj.session,opts.voteHash=opts.voteID+opts.sessionKey,tvote__itemSend_continue(opts)},error:function(data){console.log("Fatal error:"),console.log(data),tvote__changeVoteCondition(opts,"remove"),tvote__showError(opts.voteID,"")},timeout:15e3})}function tvote__itemSend_continue(opts,captchakey){var pageID=$(".t-records").attr("data-tilda-page-id"),projectID=$(".t-records").attr("data-tilda-project-id"),sendData={hash:opts.voteHash,projectid:projectID,pageid:pageID,host:location.protocol+"//"+location.host,time:opts.seconds_fromStart,session:opts.sessionCookie};"single"==opts.type&&(sendData.voteid=opts.voteID,sendData.answerid=opts.answerID),"multi"==opts.type&&(sendData.multivoteid=opts.voteID,sendData.answers=opts.answerArr),void 0!==captchakey&&(sendData.votecaptcha=captchakey,tvote__changeVoteCondition(opts,"add")),$.ajax({type:"POST",url:opts.url+"send/",crossDomain:!0,xhrFields:{withCredentials:!0},data:sendData,dataType:"text",success:function(data){opts.voteEl.removeClass("js-vote-sending t-vote_loading");var obj=$.parseJSON(data);"object"!=typeof obj&&tvote__showError(opts.voteID,""),void 0===obj.error?(opts.voteEl.addClass("js-vote-sended t-vote_sended"),tvote__writeSendCookie(obj,opts),opts.voteEl.find(".t-vote__errorbox").remove(),$(".t-vote").trigger("tildavote:resultsended")):(tvote__changeVoteCondition(opts,"remove"),opts.voteEl.removeClass("t-vote_sended"),tvote__handleServerError(obj,opts))},error:function(data){console.log("Fatal error:"),console.log(data),tvote__showError(opts.voteID,"")},timeout:15e3})}function tvote__writeSendCookie(data,opts){"ok"==data.message&&(tvote__setCookie("vote"+data.voteid,opts.voteHash,{expires:86400}),"single"==opts.type&&(tvote__setCookie("voteresult"+data.voteid,opts.answerID,{expires:86400}),tvote__setCookie("vote_candelete"+data.voteid,"yes",{expires:1800})))}function tvote__itemDelete_single(opts){opts.seconds_fromStart=((new Date).getTime()-opts.startDate.getTime())/1e3,tvote__changeVoteCondition(opts,"remove"),opts.voteEl.addClass("js-vote-sending").removeClass("t-vote_sended"),tvote__addLoadingStyle(opts.voteEl),opts.voteHash=tvote__getCookie("vote"+opts.voteID),$.ajax({type:"POST",url:"https://vote.tildacdn.com/vote/1/delete/",crossDomain:!0,data:{voteid:opts.voteID,hash:opts.voteHash,host:location.protocol+"//"+location.host},dataType:"text",success:function(data){opts.voteEl.removeClass("js-vote-sending t-vote_loading");var obj=$.parseJSON(data);"object"!=typeof obj&&tvote__showError(opts.voteID,""),void 0===obj.error?(opts.voteEl.removeClass("js-vote-sended t-vote_sended"),tvote__removeSendCookie(obj,opts)):(tvote__changeVoteCondition(opts,"add"),opts.voteEl.addClass("t-vote_sended"),tvote__handleServerError(obj,opts))},error:function(data){console.log("Fatal error:"),console.log(data),tvote__showError(opts.voteID,"")},timeout:15e3})}function tvote__removeSendCookie(data,opts){"ok"==data.message&&(tvote__setCookie("vote"+data.voteid,opts.voteHash,{expires:1}),tvote__setCookie("voteresult"+data.voteid,"",{expires:1}),tvote__setCookie("vote_candelete"+data.voteid,"",{expires:1}))}function tvote__addLoadingStyle(voteBlock){setTimeout((function(){voteBlock.hasClass("js-vote-sending")&&voteBlock.addClass("t-vote_loading")}),150)}function tvote__checkVoteCondition(opts){var curVoteCookie=tvote__getCookie("vote"+opts.voteID),curVoteResult=tvote__getCookie("voteresult"+opts.voteID);("yes"==opts.voteVisibility||"onclick"==opts.voteVisibility&&void 0!==curVoteCookie)&&opts.voteEl.find(".t-vote__btn-res").css("display","block"),void 0!==curVoteCookie&&opts.voteEl.addClass("js-vote-sended t-vote_sended"),"single"==opts.type&&void 0!==curVoteCookie&&void 0!==curVoteResult&&opts.voteEl.find("[data-answer-id="+curVoteResult+"] .t-vote__btn-el").addClass("t-vote__btn-el_active"),tvote__getResult(opts.voteID)}function tvote__handleServerError(data,opts){if(6==data.error)return window.tvote_opts=opts,void addTildaCaptcha();var errorText="";errorText="RU"==window.tildaBrowserLang?"Что-то пошло не так и голосование не может корректно работать. Пожалуйста, попробуйте другой браузер, отключите режим инкогнито или обратитесь к владельцу сайта.":"Something went wrong and vote doesn't work correctly. Please, try another browser, unlock private mode or write to website owner.",1==data.error&&(errorText="RU"==window.tildaBrowserLang?"С этого IP недавно голосовали. Пожалуйста, подождите 10 минут и попробуйте еще раз.":"Somebody has recently voted from this IP. Please wait 10 minutes and try again."),2==data.error&&(errorText="RU"==window.tildaBrowserLang?"С вашего IP адреса приходит слишком много запросов к серверу. Сервер временно не может принимать голоса с этого IP. Пожалуйста, попробуйте еще раз позже.":"There are too many votes from your IP. Server temporarily can't get votes from this IP. Please, try again later."),4==data.error&&(errorText="RU"==window.tildaBrowserLang?"Извините, но голос удалить уже нельзя. Удалить голос можно только в течение 30 минут после активации.":"Sorry, but you can't delete vote now. You can delete votes just during 30 minutes after activation."),5==data.error&&(errorText="RU"==window.tildaBrowserLang?"С вашего IP запросы приходят слишком часто. Пожалуйста, подождите 7 секунд прежде чем выбирать ответы в слудующих голосованиях на странице.":"Votes are sended too often from your IP. Please wait 7 seconds between choosing answers in different votes."),tvote__showError(opts.voteID,errorText)}function addTildaCaptcha(){$("#tildavotecaptchabox").remove(),$("body").append('<div id="tildavotecaptchabox" style="z-index: 100000;position:fixed; text-align: center; vertical-align: middle; top: 0px; left:0px; bottom: 0px; right: 0px; background: rgba(255,255,255,0.97);"><iframe id="captchaIframeBox" src="https://vote.tildacdn.com/vote/1/send/showcaptcha.php" frameborder="0" width="100%" height="100%"></iframe></div>'),window.removeEventListener("message",checkVerifyTildaVoteCaptcha),window.addEventListener("message",checkVerifyTildaVoteCaptcha)}function checkVerifyTildaVoteCaptcha(){if(-1!=event.origin.indexOf("vote.tildacdn.com")){if("closeiframe"==event.data)return void $("#tildaformcaptchabox").remove();$("#tildavotecaptchabox").remove(),tvote__itemSend_continue(window.tvote_opts,event.data)}}function tvote__showError(voteID,errorText){""==errorText&&(errorText="RU"==window.tildaBrowserLang?"Что-то пошло не так и голосование может работать некорректно. Пожалуйста, проверьте соединение с интернетом или обратитесь к владельцу сайта.":"Something went wrong and vote doesn't work correctly. Please, check your internet connection or write to website owner.");var el_vote=$("[data-vote-id="+voteID+"]"),type=el_vote.attr("data-vote-type");if("single"==type||void 0===type){var errorEl="<div class='t-vote__errorbox'><div class='t-vote__errorbox-text t-text t-text_xs t-align_center' style='background-color:#333;color:#fff;padding:20px;margin-top:30px;'>"+errorText+"</div></div>";el_vote.after(errorEl),el_vote.css("display","none")}if("multi"==type){var existingErrorEl;el_vote.find(".t-vote__errorbox").remove();var errorEl="<div class='t-vote__errorbox'><div class='t-vote__errorbox-text t-text t-text_xs t-align_center' style='background-color:#F95D51;color:#fff;padding:20px;margin:30px 0px;'>"+errorText+"</div></div>";el_vote.find(".js-sendvote-btn").last().before(errorEl)}}function tvote__getResult(voteID){var el_vote=$("[data-vote-id="+voteID+"]"),type=el_vote.attr("data-vote-type");if("single"==type)var url="https://vote.tildacdn.com/vote/1/getresult/";if("multi"==type)var url="https://vote.tildacdn.com/vote/2/getresult/";void 0!==type&&$.ajax({type:"GET",url:url,crossDomain:!0,data:{voteid:voteID,host:location.protocol+"//"+location.host},async:!1,dataType:"text",success:function(data){var obj;try{console.log(data),obj=$.parseJSON(data)}catch(error){return console.log("Fatal error:"),console.log(error),void tvote__showError(voteID,"")}"object"!=typeof obj&&tvote__showError(voteID,""),void 0===obj.error?("single"==type&&Object.keys(obj[0]).forEach((function(key){el_vote.find("[data-answer-id="+key+"] .js-vote-count").html(obj[0][key])})),"multi"==type&&($.each(obj[0],(function(vid,value){var sum=0;$.each(value,(function(aid,amount){sum+=1*amount})),$.each(value,(function(aid,amount){var percentage=Math.round(100*amount/sum),answerID=aid.slice(0,aid.indexOf("-")),answerEl=el_vote.find("[data-question-id="+vid+"] [data-answer-id="+answerID+"]");answerEl.find(".js-vote-count").html(amount),answerEl.find(".js-vote-percent").html(percentage+"%")}))})),setTimeout((function(){$(".t-vote").trigger("tildavote:numberschanged")}),1e3))):el_vote.find(".t-vote__btn-res").css("display","none")},error:function(data){console.log("Fatal error:"),console.log(data),tvote__showError(voteID,"")},timeout:5e3})}function tvote__changeVoteCondition(opts,action){"multi"==opts.type&&tvote__changeStat(opts,action),"single"==opts.type&&"add"==action&&(tvote__incrementAnswerNum(opts.voteID,opts.answerID),opts.voteEl.find("[data-answer-id="+opts.answerID+"] .t-vote__btn-el").addClass("t-vote__btn-el_active")),"single"==opts.type&&"remove"==action&&(tvote__decrementAnswerNum(opts.voteID,opts.answerID),opts.voteEl.find(".t-vote__btn-el_active").removeClass("t-vote__btn-el_active"))}function tvote__changeStat(opts,action){var questions;opts.voteEl.find(".js-vote-question").each((function(){var answers=$(this).find(".js-vote-item"),sum=0;answers.each((function(){var numEl=$(this).find(".js-vote-count");if(void 0!==numEl){var amount=1*numEl.html();sum+=amount;var checkedEl=$(this).find(".js-vote-btn:checked").length;0!=checkedEl&&"add"==action&&(sum++,amount++,numEl.html(amount)),0!=checkedEl&&"remove"==action&&(sum--,amount--,numEl.html(amount))}})),answers.each((function(){var numEl=$(this).find(".js-vote-count"),percentEl=$(this).find(".js-vote-percent"),amount=1*numEl.html(),percentage=Math.round(100*amount/sum);0!=sum?(numEl.html(amount),void 0!==percentEl&&percentEl.html(percentage+"%")):(numEl.html("0"),void 0!==percentEl&&percentEl.html("0%"))}))})),$(".t-vote").trigger("tildavote:numberschanged")}function tvote__incrementAnswerNum(voteID,answerid){var curNum=$("[data-vote-id="+voteID+"] [data-answer-id="+answerid+"] .js-vote-count"),curValue=curNum.html();curNum.html(1*++curValue)}function tvote__decrementAnswerNum(voteID,answerid){var curNum=$("[data-vote-id="+voteID+"] [data-answer-id="+answerid+"] .js-vote-count"),curValue=curNum.html();curNum.html(1*--curValue)}function tvote__getCookie(name){var matches=document.cookie.match(new RegExp("(?:^|; )"+name.replace(/([.$?*|{}()[\]\\/+^])/g,"\\$1")+"=([^;]*)"));return matches?decodeURIComponent(matches[1]):void 0}function tvote__setCookie(name,value,options){var expires=(options=options||{}).expires;if("number"==typeof expires&&expires){var d=new Date;d.setTime(d.getTime()+1e3*expires),expires=options.expires=d}expires&&expires.toUTCString&&(options.expires=expires.toUTCString());var updatedCookie=name+"="+(value=encodeURIComponent(value));for(var propName in options){updatedCookie+="; "+propName;var propValue=options[propName];!0!==propValue&&(updatedCookie+="="+propValue)}document.cookie=updatedCookie}